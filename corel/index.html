<html>
	<script type="text/javascript">
		function selectAction(id){
			document.getElementById("circ").className = "bt";
			document.getElementById("eli").className = "bt";
			document.getElementById("FFill").className = "bt";

			document.getElementById(id).className += " selecionado";
		}

		function selectColor(id){
			document.getElementById("preto").className = "cores";
			document.getElementById("vermelho").className = "cores";
			document.getElementById("verde").className = "cores";
			document.getElementById("azul").className = "cores";

			document.getElementById(id).className += " selectedColor";
		}
	</script>	

	<head>
		<title>CorelDraw CG</title>
		<link rel="stylesheet" type="text/css" href="../css/style.css" />
		<meta charset="UTF-8"/>
	</head>
	<body onload="main();">
		<abbr title = "CircunferÃªncia"><button class="bt selecionado" id="circ" onclick="algorithm=Algorithms.CIRC; selectAction(this.id);">O</button> </abbr>
		<abbr title = "Elipse"> <button class="bt" id="eli" onclick="algorithm=Algorithms.ELIPSE; selectAction(this.id);">0</button> </abbr>
		<abbr title = "FFill"> <button class="bt" id="FFill" onclick="algorithm=Algorithms.FFill; selectAction(this.id);">Pinta</button> </abbr>
		<button class="bt" onclick="limpaCanvas()">Limpar Tela</button>
		<div id="preto" class="cores" onclick="COR=[0,0,0,255]; selectColor(this.id);"></div>
		<div id="vermelho" class="cores" onclick="COR=[255,0,0,255]; selectColor(this.id);"></div>
		<div id="verde" class="cores" onclick="COR=[0,255,0,255]; selectColor(this.id);"></div>
		<div id="azul" class="cores" onclick="COR=[0,0,255,255]; selectColor(this.id);"></div>
		
		<center>
			<canvas id="canvas"> </canvas> 
		</center>
	</body>

	<script>
		var cv;
		var ctx;

		Algorithms = {
			CIRC : 0,
			ELIPSE : 1,
			FFill : 2
		}

		var algorithm = Algorithms.CIRC;

		var COR = [0, 0, 0, 255];

		var pontos = [];

		function main(){
			cv = document.getElementById("canvas");
			ctx = cv.getContext("2d");
			
			cv.width = 400;
			cv.height = 300;

			limpaCanvas();

			cv.onmousedown = function(event){
				var pontoClicado = [getMousePos(cv, event).x, getMousePos(cv, event).y];
				pontos.push(pontoClicado); 

				if(algorithm == Algorithms.FFill){
					FFill(pontoClicado, COR, getPixel(pontoClicado[0], pontoClicado[1]));
					pontos = [];
				}

				if(pontos.length == 2){
					desenha(event);
				}
			}
		}

		function getPixel(x, y){
            var imgData = ctx.getImageData(x, y, 1, 1);
            return imgData.data;
        }

		function getMousePos(canvas, evt) {
			var rect = canvas.getBoundingClientRect();
			return {
				x: Math.round(evt.clientX - rect.left),
				y: Math.round(evt.clientY - rect.top)
			};
		}

		function setPixel( x, y, cor ){
			var id = ctx.createImageData(1,1);
			var d  = id.data; 
			d[0]   = cor[0];
			d[1]   = cor[1];
			d[2]   = cor[2];
			d[3]   = cor[3];
			
			ctx.putImageData( id, Math.floor(x+0.5), Math.floor(y+0.5) );    
		}

		function limpaCanvas(){
			ctx.fillStyle = "#FFFFFF";
			ctx.fillRect(0, 0, cv.width, cv.height);
		}

		function hip(points){
			return Math.sqrt(Math.pow((points[1][1] - points[0][1]), 2) + Math.pow((points[1][0] - points[0][0]), 2));
		}

		function desenha(event){
			switch(algorithm){
				case Algorithms.CIRC:
					circunferencia(pontos[0], hip(pontos), COR);
					pontos = [];
					break;
				case Algorithms.ELIPSE:
					elipse(pontos[0], Math.abs(pontos[1][0] - pontos[0][0]), Math.abs(pontos[1][1] - pontos[0][1]), COR);
					pontos = [];
					break;
			}
		}

        function FFill(ponto, corF, corI){
        	if( corI == corF ){
        		return;
        	}
        	var pixels = [];
        	pixels.push(ponto);

        	while(pixels.length > 0){
        		var n = pixels[0];
        		pixels.splice(0, 1);

        		var corPixelAtual = getPixel(n[0], n[1]);
        		if(corPixelAtual[0] == corI[0] && corPixelAtual[1] == corI[1] && corPixelAtual[2] == corI[2]){
        			setPixel(n[0], n[1], corF);

        			var corPixelDireito = getPixel(n[0] + 1, n[1]);
        			if(corPixelDireito[0] == corI[0] && corPixelDireito[1] == corI[1] && corPixelDireito[2] == corI[2]){
        				pixels.push([n[0] + 1, n[1]]);
        			}
        			var corPixelEsquerdo = getPixel(n[0] - 1, n[1]);
        			if(corPixelEsquerdo[0] == corI[0] && corPixelEsquerdo[1] == corI[1] && corPixelEsquerdo[2] == corI[2]){
        				pixels.push([n[0] - 1, n[1]]);
        			}
        			var corPixelCima = getPixel(n[0], n[1] - 1);
        			if(corPixelCima[0] == corI[0] && corPixelCima[1] == corI[1] && corPixelCima[2] == corI[2]){
        				pixels.push([n[0], n[1] - 1]);
        			}
        			var corPixelBaixo = getPixel(n[0], n[1] + 1);
        			if(corPixelBaixo[0] == corI[0] && corPixelBaixo[1] == corI[1] && corPixelBaixo[2] == corI[2]){
        				pixels.push([n[0], n[1] + 1]);
        			}

        		}
        	}
        }

        function FFill2(ponto, corF, corI){
        	if( corI == corF ){
        		return;
        	}
        	var pixels = [];
        	pixels.push(ponto);

        	for(var i = 0; i < pixels.length; i++){
        		var n = pixels[i];
        		var w = [n[0]+0, n[1]+0], e = [n[0]+0, n[1]+0];

        		var corW = getPixel(w[0], w[1]);
        		while(corW[0] == corI[0] && corW[1] == corI[1] && corW[2] == corI[2]){
        			w[0]--;
        			corW = getPixel(w[0], w[1]);
        		}
        		var corE = getPixel(e[0], e[1]);
        		while(corE[0] == corI[0] && corE[1] == corI[1] && corE[2] == corI[2]){
        			e[0]++;
        			corE = getPixel(e[0], e[1]);
        		}

        		for(var j = w[0]+1; j < e[0]; j++){
        			setPixel(j, n[1], corF); 

        			var corPixelDeCima = getPixel(n[0], n[1]-1);
	        		if(corPixelDeCima[0] == corI[0] && corPixelDeCima[1] == corI[1] && corPixelDeCima[2] == corI[2]){
	        			pixels.push([n[0], n[1]-1]);
	        		}
	        		var corPixelDeBaixo = getPixel(n[0], n[1]+1);
	        		if(corPixelDeBaixo[0] == corI[0] && corPixelDeBaixo[1] == corI[1] && corPixelDeBaixo[2] == corI[2]){
	        			pixels.push([n[0], n[1]+1]);
	        		}
        		}
        	}
        }

		function circunferencia(xyc, r, cor){
			var x=0, y=r;
			var p = 1 - r;

			setPixel(x+xyc[0], y+xyc[1], cor); setPixel(-x+xyc[0],-y+xyc[1],cor);	setPixel(-x+xyc[0],y+xyc[1],cor); setPixel(x+xyc[0] ,-y+xyc[1],cor);
			setPixel(y+xyc[0] ,x+xyc[1] ,cor); setPixel(-y+xyc[0], -x+xyc[1],cor); setPixel(-y+xyc[0],x+xyc[1],cor);	setPixel(y+xyc[0],-x+xyc[1],cor);

			//for(var k=0; k<r*0.75;k++){
			while(x < y + 1){
				if(p > 0){
					y--;
					p -= 2 * y;
				}
				x++;
				p += 2 * x + 1;

				setPixel(x+xyc[0], y+xyc[1], cor); setPixel(-x+xyc[0],-y+xyc[1],cor); setPixel(-x+xyc[0],y+xyc[1],cor); setPixel(x+xyc[0] ,-y+xyc[1],cor);
				setPixel(y+xyc[0] ,x+xyc[1] ,cor); setPixel(-y+xyc[0], -x+xyc[1],cor); setPixel(-y+xyc[0],x+xyc[1],cor); setPixel(y+xyc[0],-x+xyc[1],cor);
			}
		}

		function elipse(ponto, r1, r2, cor){
			var x = 0, y = r2;
			var r1q = r1 * r1, r2q = r2 * r2;

			var p1 = r2q - r1q * r2 + r1q / 4;

			setPixel(ponto[0], ponto[1]+r2, cor);
			setPixel(ponto[0], ponto[1]-r2, cor);
			setPixel(ponto[0]+r1, ponto[1], cor);
			setPixel(ponto[0]-r1, ponto[1], cor);

			while(r1q * (y-1/2) > r2q * (x + 1)){

				if(p1 < 0){
					x++;
				} else{
					p1 += r1q * (-2 * y + 2);
					x++;
					y--;
				}
				p1 += r2q * (2 * x + 3);

				setPixel(ponto[0] + x, ponto[1] + y, cor);
				setPixel(ponto[0] + x, ponto[1] - y, cor);
				setPixel(ponto[0] - x, ponto[1] + y, cor);
				setPixel(ponto[0] - x, ponto[1] - y, cor);

			}

			var p2 = (r2q * (x + 1 / 2) * (x + 1 / 2) + r1q * (y - 1) * (y - 1) - r1q * r2q);

			while(y > 0){
				if(p2 < 0){
					p2 += r2q * (2 * x + 2);
					x++;
					y--;
				} else {
					y--;
				}
				p2 += r1q * (-2 * y + 3);

				setPixel(ponto[0] + x, ponto[1] + y, cor);
				setPixel(ponto[0] + x, ponto[1] - y, cor);
				setPixel(ponto[0] - x, ponto[1] + y, cor);
				setPixel(ponto[0] - x, ponto[1] - y, cor);
			}

		}

	</script>